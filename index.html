<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Meme Outbreak: Pandemic Legacy</title>
    <style>
        /* --- THEME & RESET --- */
        :root {
            --bg-body: #050505;
            --bg-panel: #111;
            --border: #333;
            --accent-red: #b91c1c;   /* Disease/Infection */
            --accent-blue: #3b82f6;  /* Cure/Ban */
            --accent-gold: #eab308;  /* DNA/Points */
            --text-main: #eee;
            --text-dim: #888;
            --font-ui: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            --font-mono: "Courier New", Courier, monospace;
        }

        * { box-sizing: border-box; user-select: none; }

        body {
            margin: 0;
            background: var(--bg-body);
            color: var(--text-main);
            font-family: var(--font-ui);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        /* --- MAIN LAYOUT --- */
        #gameContainer {
            width: 1024px;
            height: 768px;
            background: var(--bg-panel);
            border: 2px solid #444;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            display: grid;
            grid-template-rows: 40px 1fr 160px; /* Header, Map, HUD */
            position: relative;
        }

        /* --- HEADER / TICKER --- */
        header {
            background: #1a1a1a;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            overflow: hidden;
            padding: 0 10px;
        }
        .news-badge {
            background: var(--accent-red);
            color: #fff;
            padding: 2px 8px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-right: 10px;
            border-radius: 2px;
        }
        #newsTicker {
            white-space: nowrap;
            font-family: var(--font-mono);
            font-size: 0.9rem;
            color: #ccc;
            animation: ticker 25s linear infinite;
        }
        @keyframes ticker { from { transform: translateX(100%); } to { transform: translateX(-100%); } }

        /* --- MAP AREA --- */
        #mapStage {
            position: relative;
            background: radial-gradient(circle at 50% 50%, #1a202c 0%, #000 100%);
            overflow: hidden;
            cursor: crosshair;
        }
        
        svg { width: 100%; height: 100%; display: block; }
        
        .college-rect {
            fill: #333;
            stroke: #555;
            stroke-width: 1;
            transition: fill 0.3s;
        }
        .college-rect:hover { stroke: #fff; }
        
        /* College Labels */
        .map-label {
            font-family: var(--font-mono);
            font-size: 10px;
            fill: #888;
            pointer-events: none;
            text-transform: uppercase;
        }

        /* Visual Effects Layers */
        #particleCanvas {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
        }
        
        /* DNA Bubbles */
        .bubble {
            position: absolute;
            width: 40px; height: 40px;
            border-radius: 50%;
            border: 2px solid #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            cursor: pointer;
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10;
            box-shadow: 0 0 15px currentColor;
        }
        .bubble-dna {
            background: radial-gradient(circle at 30% 30%, #fef08a, #ca8a04);
            color: #422006;
            color: var(--accent-gold);
        }
        .bubble-cure {
            background: radial-gradient(circle at 30% 30%, #bfdbfe, #2563eb);
            color: white;
            box-shadow: 0 0 15px var(--accent-blue);
        }

        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
        @keyframes float { 0% { transform: translateY(0); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0); } }

        /* --- HUD --- */
        #hud {
            background: linear-gradient(to bottom, #222, #0d0d0d);
            border-top: 1px solid #444;
            display: grid;
            grid-template-columns: 220px 1fr 220px;
            padding: 15px;
            gap: 20px;
        }

        /* Stats Column */
        .stat-box {
            font-family: var(--font-mono);
            font-size: 0.85rem;
            color: var(--text-dim);
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 5px;
        }
        .stat-row { display: flex; justify-content: space-between; }
        .val-dna { color: var(--accent-gold); font-weight: bold; font-size: 1.1rem; }
        .val-inf { color: var(--accent-red); font-weight: bold; }
        .val-dead { color: #555; }

        /* Middle Controls */
        .controls-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
        }

        .progress-container { width: 100%; }
        .bar-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; display: flex; justify-content: space-between; }
        
        .progress-track {
            background: #000;
            border: 1px solid #333;
            height: 14px;
            border-radius: 7px;
            overflow: hidden;
            position: relative;
        }
        .progress-fill {
            height: 100%;
            width: 0%;
            transition: width 0.2s linear;
        }
        #barBan { background: linear-gradient(90deg, #1e40af, #60a5fa); }
        #barInf { background: linear-gradient(90deg, #7f1d1d, #ef4444); }

        .time-controls {
            display: flex;
            gap: 5px;
            background: #111;
            padding: 4px;
            border-radius: 4px;
            border: 1px solid #333;
        }
        .btn-time {
            background: transparent;
            border: none;
            color: #666;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 2px;
        }
        .btn-time.active { background: #333; color: #fff; }
        .btn-time:hover { color: #fff; }

        /* Actions Column */
        .actions-box {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 15px;
        }
        .big-btn {
            width: 90px; height: 90px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #333, #000);
            border: 2px solid #555;
            color: #ddd;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            transition: transform 0.1s, border-color 0.2s;
        }
        .big-btn:hover { transform: scale(1.05); border-color: #999; }
        .btn-disease { color: var(--accent-red); border-color: #7f1d1d; }
        .btn-disease:hover { border-color: var(--accent-red); box-shadow: 0 0 15px rgba(185, 28, 28, 0.3); }

        /* --- MODAL (EVOLUTION) --- */
        .modal-backdrop {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .modal-window {
            width: 800px; height: 600px;
            background: #0a0a0a;
            border: 1px solid #444;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 40px rgba(0,0,0,1);
        }
        .modal-header {
            background: #151515;
            border-bottom: 1px solid #333;
            height: 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        .tab-group { display: flex; height: 100%; }
        .tab-btn {
            background: transparent; border: none;
            color: #666; font-weight: bold;
            padding: 0 20px; height: 100%;
            cursor: pointer;
            border-right: 1px solid #222;
            text-transform: uppercase;
            font-size: 0.85rem;
        }
        .tab-btn.active { background: #222; color: #fff; border-bottom: 3px solid var(--accent-red); }
        
        .modal-body { flex: 1; padding: 20px; overflow-y: auto; }
        
        .upgrade-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 15px;
        }
        .upgrade-card {
            background: #1a1a1a;
            border: 1px solid #333;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .upgrade-card:hover { background: #222; border-color: #555; }
        .upgrade-card.owned { background: #2a1212; border-color: var(--accent-red); opacity: 0.8; }
        .upgrade-card.locked { opacity: 0.3; pointer-events: none; filter: grayscale(1); }
        
        .card-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .card-name { font-weight: bold; color: #fff; font-size: 0.9rem; }
        .card-cost { color: var(--accent-gold); font-family: var(--font-mono); font-size: 0.85rem; }
        .card-desc { font-size: 0.75rem; color: #888; line-height: 1.3; }

        .close-btn {
            background: #333; border: none; color: #fff;
            width: 30px; height: 30px; cursor: pointer; font-weight: bold;
        }
        .close-btn:hover { background: var(--accent-red); }

        /* --- GAME OVER --- */
        #screenGameOver {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 200;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .go-title { font-size: 4rem; margin: 0 0 20px 0; text-transform: uppercase; letter-spacing: 5px; }
        .go-win { color: var(--accent-red); text-shadow: 0 0 20px var(--accent-red); }
        .go-lose { color: var(--accent-blue); text-shadow: 0 0 20px var(--accent-blue); }
        .go-desc { max-width: 500px; color: #aaa; font-size: 1.2rem; margin-bottom: 40px; line-height: 1.5; }
        .btn-restart {
            background: transparent; border: 2px solid #fff; color: #fff;
            padding: 10px 40px; font-size: 1.2rem; cursor: pointer;
            text-transform: uppercase; font-weight: bold;
            transition: all 0.2s;
        }
        .btn-restart:hover { background: #fff; color: #000; }

    </style>
</head>
<body>

<div id="gameContainer">
    
    <header>
        <div class="news-badge">NEWS</div>
        <div id="newsTicker">Local meme seen on Reddit... Administrators concerned about productivity...</div>
    </header>

    <div id="mapStage">
        <svg id="svgMap" viewBox="0 0 800 500" preserveAspectRatio="xMidYMid slice"></svg>
        <canvas id="particleCanvas"></canvas>
        <div id="bubbleLayer"></div>
    </div>

    <div id="hud">
        <div class="stat-box">
            <div class="stat-row">
                <span>DNA POINTS</span>
                <span class="val-dna" id="valDNA">0</span>
            </div>
            <div style="height: 10px;"></div>
            <div class="stat-row">
                <span>INFECTED</span>
                <span class="val-inf" id="valInf">0</span>
            </div>
            <div class="stat-row">
                <span>HEALTHY</span>
                <span class="val-dead" id="valSafe">100%</span>
            </div>
            <div class="stat-row" style="margin-top:10px;">
                <span>DAY</span>
                <span id="valDay">1</span>
            </div>
        </div>

        <div class="controls-box">
            <div class="progress-container">
                <div class="bar-label">
                    <span style="color:var(--accent-blue)">Admin Ban Progress</span>
                    <span id="lblBan">0%</span>
                </div>
                <div class="progress-track">
                    <div class="progress-fill" id="barBan"></div>
                </div>
            </div>

            <div class="progress-container">
                <div class="bar-label">
                    <span style="color:var(--accent-red)">Campus Saturation</span>
                    <span id="lblInf">0%</span>
                </div>
                <div class="progress-track">
                    <div class="progress-fill" id="barInf"></div>
                </div>
            </div>

            <div class="time-controls">
                <button class="btn-time" onclick="Game.setSpeed(0)">||</button>
                <button class="btn-time active" id="btnS1" onclick="Game.setSpeed(1)">1</button>
                <button class="btn-time" id="btnS2" onclick="Game.setSpeed(2)">2</button>
                <button class="btn-time" id="btnS3" onclick="Game.setSpeed(4)">3</button>
            </div>
        </div>

        <div class="actions-box">
            <div class="big-btn btn-disease" onclick="UI.toggleModal(true)">
                <div>DISEASE</div>
                <div style="font-size:0.6rem; font-weight:normal;">EVOLVE</div>
            </div>
            <div class="big-btn" style="border-color:#444; color:#666; cursor:default;">
                <div>WORLD</div>
                <div style="font-size:0.6rem; font-weight:normal;">DATA</div>
            </div>
        </div>
    </div>

    <div class="modal-backdrop" id="evoModal">
        <div class="modal-window">
            <div class="modal-header">
                <div class="tab-group">
                    <button class="tab-btn active" onclick="UI.setTab('transmission')">Transmission</button>
                    <button class="tab-btn" onclick="UI.setTab('symptoms')">Content</button>
                    <button class="tab-btn" onclick="UI.setTab('abilities')">Abilities</button>
                </div>
                <div style="display:flex; align-items:center; gap:15px;">
                    <span style="color:var(--accent-gold); font-weight:bold;">DNA: <span id="modalDNA">0</span></span>
                    <button class="close-btn" onclick="UI.toggleModal(false)">X</button>
                </div>
            </div>
            <div class="modal-body" id="evoBody">
                </div>
        </div>
    </div>

    <div id="screenGameOver">
        <h1 class="go-title" id="goTitle">VICTORY</h1>
        <p class="go-desc" id="goDesc">Text goes here.</p>
        <button class="btn-restart" onclick="location.reload()">Play Again</button>
    </div>

</div>

<script>
/**
 * MEME OUTBREAK: PANDEMIC LEGACY
 * A vanilla JS clone of the flash classic.
 */

/* --- CONFIGURATION --- */
const DATA = {
    colleges: [
        // X, Y percent coordinates on an 800x500 map
        { id: "BF", name: "Ben Franklin", x: 0.10, y: 0.75, pop: 450, type: "Social" },
        { id: "PM", name: "Pauli Murray", x: 0.10, y: 0.25, pop: 450, type: "Digital" },
        { id: "BK", name: "Berkeley", x: 0.30, y: 0.75, pop: 400, type: "Social" },
        { id: "GH", name: "Grace Hopper", x: 0.30, y: 0.55, pop: 380, type: "Digital" },
        { id: "TC", name: "Trumbull", x: 0.50, y: 0.15, pop: 390, type: "Academic" },
        { id: "BR", name: "Branford", x: 0.50, y: 0.75, pop: 410, type: "Physical" },
        { id: "SY", name: "Saybrook", x: 0.55, y: 0.55, pop: 400, type: "Academic" },
        { id: "JE", name: "Jonathan Edwards", x: 0.50, y: 0.55, pop: 380, type: "Academic" },
        { id: "PC", name: "Pierson", x: 0.35, y: 0.25, pop: 420, type: "Digital" },
        { id: "DC", name: "Davenport", x: 0.70, y: 0.75, pop: 430, type: "Academic" },
        { id: "MC", name: "Morse", x: 0.70, y: 0.55, pop: 400, type: "Physical" },
        { id: "ES", name: "Ezra Stiles", x: 0.10, y: 0.55, pop: 400, type: "Social" },
        { id: "SM", name: "Silliman", x: 0.75, y: 0.25, pop: 440, type: "Social" },
        { id: "TD", name: "Timothy Dwight", x: 0.25, y: 0.15, pop: 390, type: "Social" }
    ],
    upgrades: {
        transmission: [
            { id: "t_insta", name: "Instagram Page", cost: 3, type: "Digital", desc: "Allows infection in Digital colleges." },
            { id: "t_woads", name: "Woads Night", cost: 5, type: "Social", desc: "Allows infection in Social colleges." },
            { id: "t_chalk", name: "Sidealk Chalk", cost: 4, type: "Physical", desc: "Allows infection in Physical colleges." },
            { id: "t_section", name: "Section Chatter", cost: 4, type: "Academic", desc: "Allows infection in Academic colleges." },
            { id: "t_tiktok", name: "TikTok Trend", cost: 10, req: "t_insta", desc: "Massively boosts spread speed." },
            { id: "t_party", name: "Frat Party Theme", cost: 12, req: "t_woads", desc: "Spread increases when people gather." },
            { id: "t_sticker", name: "Laptop Stickers", cost: 8, req: "t_chalk", desc: "Passive spread increase." },
            { id: "t_groupme", name: "GroupMe Spam", cost: 9, req: "t_section", desc: "High annoyance, high spread." }
        ],
        symptoms: [
            { id: "s_cap", name: "Funny Caption", cost: 2, inf: 2, vis: 1, desc: "Slightly increases infectivity." },
            { id: "s_img", name: "Cursed Image", cost: 4, inf: 5, vis: 3, desc: "People share it because it's weird." },
            { id: "s_vid", name: "Video Format", cost: 8, inf: 8, vis: 5, desc: "Higher engagement." },
            { id: "s_pol", name: "Political Take", cost: 10, inf: 15, vis: 20, desc: "Huge spread, but Admins act fast." },
            { id: "s_prof", name: "Mocking Profs", cost: 12, inf: 10, vis: 15, desc: "Academic circles love it." },
            { id: "s_deep", name: "Deep Fried", cost: 6, inf: 6, vis: 2, desc: "Harder for older admins to understand." }
        ],
        abilities: [
            { id: "a_obs", name: "Obscurity", cost: 6, desc: "Reduces Visibility (Ban Speed) by 20%." },
            { id: "a_vpn", name: "VPN Usage", cost: 10, desc: "Ban progress slows down by 15%." },
            { id: "a_alumni", name: "Alumni Support", cost: 20, desc: "Massive reduction in Ban speed." },
            { id: "a_mutate", name: "Rapid Mutation", cost: 15, desc: "Randomly gain free Content upgrades." }
        ]
    }
};

/* --- GAME ENGINE --- */
const Game = {
    dna: 10,
    totalPop: 0,
    infectedPop: 0,
    day: 1,
    tick: 0,
    speed: 1,
    banProgress: 0,
    banRate: 0,
    visibility: 0,
    infectivity: 1,
    paused: false,
    ended: false,
    
    colleges: [],
    ownedUpgrades: [],
    
    particles: [],

    init() {
        // Calculate total pop
        DATA.colleges.forEach(c => {
            Game.totalPop += c.pop;
            Game.colleges.push({
                ...c,
                infected: 0,
                color: 0 // 0 to 1 intensity
            });
        });

        // Start Infection in Ben Franklin
        Game.colleges[0].infected = 5; 

        // Render Map
        UI.renderMap();
        
        // Start Loop
        requestAnimationFrame(Game.loop);
        
        // Input Listeners
        UI.initListeners();
    },

    setSpeed(s) {
        Game.speed = s;
        document.querySelectorAll('.btn-time').forEach((b, i) => {
            if ((i===0 && s===0) || (i===1 && s===1) || (i===2 && s===2) || (i===3 && s===4)) {
                b.classList.add('active');
            } else {
                b.classList.remove('active');
            }
        });
    },

    loop() {
        if (Game.ended) return;
        
        if (Game.speed > 0) {
            // Game tick runs based on speed
            for(let i=0; i<Game.speed; i++) {
                Game.tick++;
                if (Game.tick % 60 === 0) { // Roughly every "hour"
                    Game.updateLogic();
                }
            }
            // Particle animation runs every frame regardless of logic tick
            ParticleSystem.update();
        }

        requestAnimationFrame(Game.loop);
    },

    updateLogic() {
        // 1. Spread Infection
        let newInfections = 0;
        let globalInf = 0;

        Game.colleges.forEach(c => {
            if (c.infected > 0) {
                // Internal Spread
                if (c.infected < c.pop) {
                    let rate = (Game.infectivity * 0.05) + (c.infected * 0.002);
                    // Cap rate based on population density
                    let growth = Math.ceil(rate);
                    let actual = Math.min(c.pop - c.infected, growth);
                    c.infected += actual;
                    newInfections += actual;
                    
                    // Generate Particles
                    if (Math.random() < 0.2) ParticleSystem.spawn(c);
                }

                // External Spread (Neighbor/Global)
                if (Math.random() < 0.02 * Game.infectivity) {
                    let target = Game.colleges[Math.floor(Math.random() * Game.colleges.length)];
                    // Can we infect this target? (Must own the transmission vector or already be infected)
                    let canInfect = target.infected > 0;
                    if (!canInfect) {
                        // Check upgrade type
                        let typeUpgrade = Game.ownedUpgrades.find(u => u.type === target.type);
                        if (typeUpgrade) canInfect = true;
                    }

                    if (canInfect && target.infected < target.pop) {
                        if (target.infected === 0) {
                            // First infection event
                            target.infected = 1;
                            UI.spawnBubble(target.x, target.y, 'dna');
                            UI.ticker(`Outbreak confirmed in ${target.name}!`);
                        }
                        // Send particle
                        ParticleSystem.travel(c, target);
                    }
                }
            }
            globalInf += c.infected;
            
            // Visual update for college
            let intensity = c.infected / c.pop;
            document.getElementById(`col_${c.id}`).style.fill = `rgba(185, 28, 28, ${0.2 + (intensity * 0.8)})`;
        });

        Game.infectedPop = globalInf;

        // 2. Ban Progress
        // Ban speed depends on Visibility and how many people are infected (Panic)
        if (Game.infectedPop > 50) {
            let panicFactor = Game.infectedPop / Game.totalPop; // 0 to 1
            let baseRate = (Game.visibility * 0.001) + (panicFactor * 0.05);
            
            // Ability reducers
            if (Game.hasUpgrade('a_obs')) baseRate *= 0.8;
            if (Game.hasUpgrade('a_vpn')) baseRate *= 0.85;
            if (Game.hasUpgrade('a_alumni')) baseRate *= 0.5;

            Game.banProgress += baseRate;
            
            // Chance to spawn Cure Bubble (Reduces ban progress slightly)
            if (Math.random() < 0.005 && Game.banProgress > 10) {
                let c = Game.colleges[Math.floor(Math.random()*Game.colleges.length)];
                UI.spawnBubble(c.x, c.y, 'cure');
            }
        }

        // 3. Time / Win / Lose
        if (Game.tick % 1440 === 0) {
            Game.day++;
            UI.ticker("Another day passes...");
        }

        UI.updateHUD();
        Game.checkEnd();
    },

    hasUpgrade(id) {
        return Game.ownedUpgrades.some(u => u.id === id);
    },

    buyUpgrade(upgrade) {
        if (Game.dna >= upgrade.cost) {
            Game.dna -= upgrade.cost;
            Game.ownedUpgrades.push(upgrade);
            
            // Apply stats
            if (upgrade.inf) Game.infectivity += upgrade.inf;
            if (upgrade.vis) Game.visibility += upgrade.vis;
            
            UI.renderEvo();
            UI.updateHUD();
        }
    },

    checkEnd() {
        if (Game.banProgress >= 100) {
            Game.endGame(false);
        } else if (Game.infectedPop >= Game.totalPop * 0.99) { // 99% infection
            Game.endGame(true);
        }
    },

    endGame(win) {
        Game.ended = true;
        const screen = document.getElementById('screenGameOver');
        const title = document.getElementById('goTitle');
        const desc = document.getElementById('goDesc');

        screen.style.display = 'flex';
        if (win) {
            title.innerText = "MEME SUPREMACY";
            title.className = "go-title go-win";
            desc.innerText = "There is no escaping your meme. Even the Dean has printed it out and put it on their door. You are a legend.";
        } else {
            title.innerText = "BANNED";
            title.className = "go-title go-lose";
            desc.innerText = "The Administration has completely scrubbed the meme from the internet. Expulsions have been handed out. It's over.";
        }
    }
};

/* --- PARTICLE SYSTEM --- */
const ParticleSystem = {
    particles: [],
    ctx: null,

    init() {
        const canvas = document.getElementById('particleCanvas');
        canvas.width = 800; // Matches viewbox
        canvas.height = 500;
        this.ctx = canvas.getContext('2d');
    },

    spawn(college) {
        this.particles.push({
            x: college.x * 800 + (Math.random()*20-10),
            y: college.y * 500 + (Math.random()*20-10),
            vx: (Math.random()-0.5)*2,
            vy: (Math.random()-0.5)*2,
            life: 60,
            color: '#b91c1c'
        });
    },

    travel(source, target) {
        this.particles.push({
            x: source.x * 800,
            y: source.y * 500,
            tx: target.x * 800,
            ty: target.y * 500,
            life: 100, // Travel time
            travel: true,
            color: '#eab308' // Gold particle for transmission
        });
    },

    update() {
        if (!this.ctx) this.init();
        this.ctx.clearRect(0, 0, 800, 500);

        for (let i = this.particles.length - 1; i >= 0; i--) {
            let p = this.particles[i];
            
            if (p.travel) {
                // Move towards target
                let dx = p.tx - p.x;
                let dy = p.ty - p.y;
                p.x += dx * 0.05;
                p.y += dy * 0.05;
                if (Math.abs(dx) < 2 && Math.abs(dy) < 2) p.life = 0;
            } else {
                // Float around
                p.x += p.vx;
                p.y += p.vy;
                p.life--;
            }

            this.ctx.fillStyle = p.color;
            this.ctx.beginPath();
            this.ctx.arc(p.x, p.y, 2, 0, Math.PI * 2);
            this.ctx.fill();

            if (p.life <= 0) this.particles.splice(i, 1);
        }
    }
};

/* --- UI MANAGER --- */
const UI = {
    activeTab: 'transmission',

    initListeners() {
        // Bubbles
        document.getElementById('bubbleLayer').addEventListener('click', (e) => {
            if (e.target.classList.contains('bubble')) {
                let type = e.target.dataset.type;
                if (type === 'dna') {
                    Game.dna += (Math.floor(Math.random()*2)+1);
                    UI.updateHUD();
                } else if (type === 'cure') {
                    Game.banProgress = Math.max(0, Game.banProgress - 5);
                    UI.updateHUD();
                }
                e.target.remove();
            }
        });
    },

    renderMap() {
        const svg = document.getElementById('svgMap');
        Game.colleges.forEach(c => {
            // Draw rect
            let rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            rect.setAttribute("x", (c.x * 800) - 20);
            rect.setAttribute("y", (c.y * 500) - 20);
            rect.setAttribute("width", 40);
            rect.setAttribute("height", 40);
            rect.setAttribute("id", `col_${c.id}`);
            rect.classList.add("college-rect");
            
            // Draw Label
            let text = document.createElementNS("http://www.w3.org/2000/svg", "text");
            text.setAttribute("x", (c.x * 800) - 20);
            text.setAttribute("y", (c.y * 500) - 25);
            text.textContent = c.name;
            text.classList.add("map-label");

            svg.appendChild(rect);
            svg.appendChild(text);
        });
    },

    spawnBubble(xPct, yPct, type) {
        const layer = document.getElementById('bubbleLayer');
        const el = document.createElement('div');
        el.classList.add('bubble');
        el.classList.add(type === 'dna' ? 'bubble-dna' : 'bubble-cure');
        el.style.left = (xPct * 800 - 20) + 'px';
        el.style.top = (yPct * 500 - 20) + 'px';
        el.dataset.type = type;
        
        if (type === 'dna') el.innerHTML = "DNA";
        
        layer.appendChild(el);
        
        // Auto fade
        setTimeout(() => {
            if (el.parentNode) el.remove();
        }, 4000);
    },

    updateHUD() {
        document.getElementById('valDNA').innerText = Game.dna;
        document.getElementById('valInf').innerText = Game.infectedPop;
        document.getElementById('valSafe').innerText = Game.totalPop - Game.infectedPop;
        document.getElementById('valDay').innerText = Game.day;

        document.getElementById('barBan').style.width = Game.banProgress + '%';
        document.getElementById('lblBan').innerText = Math.floor(Game.banProgress) + '%';
        
        let infPct = (Game.infectedPop / Game.totalPop) * 100;
        document.getElementById('barInf').style.width = infPct + '%';
        document.getElementById('lblInf').innerText = Math.floor(infPct) + '%';
        
        // Sync Modal DNA
        document.getElementById('modalDNA').innerText = Game.dna;
    },

    ticker(msg) {
        const t = document.getElementById('newsTicker');
        t.innerText = msg;
        // Reset animation to show new text immediately
        t.style.animation = 'none';
        t.offsetHeight; 
        t.style.animation = 'ticker 20s linear infinite';
    },

    toggleModal(show) {
        const m = document.getElementById('evoModal');
        m.style.display = show ? 'flex' : 'none';
        if (show) this.renderEvo();
    },

    setTab(tab) {
        this.activeTab = tab;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        this.renderEvo();
    },

    renderEvo() {
        const body = document.getElementById('evoBody');
        body.innerHTML = '';
        const list = document.createElement('div');
        list.className = 'upgrade-grid';

        DATA.upgrades[this.activeTab].forEach(u => {
            let owned = Game.hasUpgrade(u.id);
            let locked = false;
            if (u.req && !Game.hasUpgrade(u.req)) locked = true;

            let card = document.createElement('div');
            card.className = `upgrade-card ${owned ? 'owned' : ''} ${locked ? 'locked' : ''}`;
            card.innerHTML = `
                <div class="card-header">
                    <span class="card-name">${u.name}</span>
                    <span class="card-cost">${owned ? 'OWNED' : u.cost}</span>
                </div>
                <div class="card-desc">${u.desc}</div>
            `;
            
            if (!owned && !locked) {
                card.onclick = () => Game.buyUpgrade(u);
            }
            
            list.appendChild(card);
        });
        
        body.appendChild(list);
    }
};

// --- BOOT ---
Game.init();

</script>
</body>
</html>
