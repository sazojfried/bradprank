<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MEME OUTBREAK: PANDEMIC LEGACY [ULTIMATE]</title>
<style>
    /* --- CRT & FLASH AESTHETIC --- */
    :root {
        --bg-dark: #050505;
        --panel-bg: #0f0f0f;
        --border-color: #3a3a3a;
        --accent-red: #cc0000;
        --accent-blue: #0066cc;
        --accent-yellow: #ffcc00;
        --text-main: #e0e0e0;
        --text-dim: #666;
        --scanline-color: rgba(0, 0, 0, 0.5);
        --glass-highlight: rgba(255, 255, 255, 0.05);
    }

    @font-face {
        font-family: 'Pixel';
        src: local('Courier New'); /* Fallback to mono */
    }

    body {
        margin: 0;
        background: #000;
        color: var(--text-main);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        height: 100vh;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
        user-select: none;
    }

    /* CRT OVERLAY EFFECT */
    .scanlines {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
        background-size: 100% 2px, 3px 100%;
        pointer-events: none;
        z-index: 999;
    }

    /* MAIN CONTAINER */
    #game-shell {
        width: 1024px;
        height: 768px;
        background: var(--panel-bg);
        border: 2px solid #222;
        box-shadow: 0 0 100px rgba(204, 0, 0, 0.1);
        display: grid;
        grid-template-rows: 50px 1fr 200px;
        position: relative;
    }

    /* --- HEADER --- */
    header {
        background: #111;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        padding: 0 15px;
        box-shadow: inset 0 -10px 20px -10px #000;
    }
    .date-display {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        color: #ccc;
        margin-right: 20px;
        border-right: 1px solid #333;
        padding-right: 20px;
    }
    .news-bar {
        flex: 1;
        background: #000;
        height: 30px;
        border: 1px solid #333;
        display: flex;
        align-items: center;
        overflow: hidden;
        position: relative;
    }
    .news-icon {
        background: var(--accent-red);
        color: white;
        height: 100%;
        display: flex;
        align-items: center;
        padding: 0 10px;
        font-size: 0.8rem;
        font-weight: bold;
        z-index: 2;
    }
    #news-ticker {
        white-space: nowrap;
        color: var(--text-main);
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        position: absolute;
        left: 100%;
        animation: ticker 15s linear infinite;
    }
    @keyframes ticker { 100% { left: -100%; } }

    /* --- MAP STAGE --- */
    #map-stage {
        position: relative;
        background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
        overflow: hidden;
    }
    
    /* Regions (Colleges) */
    .college-group { cursor: pointer; transition: opacity 0.2s; }
    .college-group:hover { filter: brightness(1.3); }
    .college-shape {
        fill: #2a2a2a;
        stroke: #444;
        stroke-width: 1;
        transition: fill 0.5s;
    }
    .college-label {
        fill: #666;
        font-size: 10px;
        font-family: monospace;
        text-transform: uppercase;
        pointer-events: none;
        text-shadow: 0 1px 2px black;
    }

    /* Particles & Bubbles */
    #fx-canvas {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none;
    }
    .bubble {
        position: absolute;
        width: 40px; height: 40px;
        border-radius: 50%;
        background: radial-gradient(circle at 30% 30%, #fff, var(--accent-yellow));
        border: 2px solid #fff;
        box-shadow: 0 0 15px var(--accent-yellow);
        display: flex;
        justify-content: center; align-items: center;
        font-weight: bold; color: #422006;
        cursor: pointer;
        z-index: 100;
        animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .bubble.cure {
        background: radial-gradient(circle at 30% 30%, #dbeafe, var(--accent-blue));
        box-shadow: 0 0 15px var(--accent-blue);
        color: #fff;
    }
    @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

    /* --- HUD AREA --- */
    #hud {
        background: linear-gradient(to bottom, #181818, #050505);
        border-top: 1px solid var(--border-color);
        display: grid;
        grid-template-columns: 300px 1fr 250px;
        padding: 15px;
        gap: 20px;
    }

    /* Left Panel: Region Data & Global Stats */
    .panel-box {
        background: #080808;
        border: 1px solid #333;
        padding: 10px;
        border-radius: 4px;
        box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        display: flex;
        flex-direction: column;
    }
    .hud-title {
        font-size: 0.7rem; color: #888; text-transform: uppercase; letter-spacing: 1px;
        border-bottom: 1px solid #333; margin-bottom: 8px; padding-bottom: 4px;
    }
    .data-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 0.9rem; }
    .val-gold { color: var(--accent-yellow); font-weight: bold; font-size: 1.2rem; }
    .val-red { color: var(--accent-red); }
    .val-blue { color: var(--accent-blue); }

    /* Center Panel: Progress & Evolution */
    .center-controls { display: flex; flex-direction: column; gap: 10px; }
    
    .bar-container { width: 100%; background: #000; border: 1px solid #444; height: 18px; border-radius: 9px; position: relative; overflow: hidden; }
    .bar-fill { height: 100%; width: 0%; transition: width 0.5s linear; }
    .bar-red { background: linear-gradient(90deg, #450a0a, #dc2626); }
    .bar-blue { background: linear-gradient(90deg, #172554, #2563eb); }
    .bar-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; font-size: 0.7rem; color: #fff; text-shadow: 0 1px 2px #000; font-weight: bold; z-index: 2;}

    .btn-disease {
        background: #222; border: 1px solid #444; color: #ccc;
        padding: 10px; text-align: center; font-weight: bold; cursor: pointer;
        transition: all 0.1s; text-transform: uppercase;
        box-shadow: 0 4px 0 #000;
        margin-top: auto;
    }
    .btn-disease:hover { background: #333; color: #fff; transform: translateY(-2px); box-shadow: 0 6px 0 #000; }
    .btn-disease:active { transform: translateY(2px); box-shadow: 0 2px 0 #000; }

    /* Right Panel: Time & Global Actions */
    .time-panel { display: flex; gap: 5px; justify-content: center; margin-bottom: 15px; }
    .btn-time {
        width: 40px; height: 30px; background: #111; border: 1px solid #444;
        color: #666; cursor: pointer; font-weight: bold;
    }
    .btn-time.active { background: #333; color: #fff; border-color: #888; }
    
    .big-circle-btn {
        width: 100px; height: 100px; border-radius: 50%;
        background: radial-gradient(circle at 30% 30%, #333, #000);
        border: 2px solid #555; color: #aaa;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        font-size: 0.8rem; font-weight: bold; margin: 0 auto;
        cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    }
    .big-circle-btn:hover { border-color: #fff; color: #fff; box-shadow: 0 0 20px rgba(255,255,255,0.1); }

    /* --- EVOLUTION MODAL --- */
    #evo-modal {
        position: absolute; top: 50px; left: 0; width: 100%; height: 518px; /* Cover Map */
        background: rgba(10, 10, 10, 0.95);
        backdrop-filter: blur(5px);
        z-index: 500; display: none; flex-direction: column;
    }
    .evo-header {
        height: 60px; background: #151515; border-bottom: 1px solid #333;
        display: flex; justify-content: space-between; align-items: center; padding: 0 30px;
    }
    .evo-tabs button {
        background: none; border: none; color: #666; font-size: 1rem; font-weight: bold;
        margin-right: 20px; cursor: pointer; text-transform: uppercase;
    }
    .evo-tabs button.active { color: #fff; text-decoration: underline; text-decoration-color: var(--accent-red); text-underline-offset: 5px;}
    
    .evo-body { flex: 1; padding: 30px; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
    
    .hex-upgrade {
        background: #1a1a1a; border: 1px solid #333; padding: 15px;
        display: flex; flex-direction: column; gap: 5px; cursor: pointer; transition: all 0.2s;
        position: relative;
    }
    .hex-upgrade:hover { background: #222; border-color: #666; }
    .hex-upgrade.owned { background: #2a0e0e; border-color: var(--accent-red); }
    .hex-upgrade.locked { opacity: 0.3; pointer-events: none; filter: grayscale(1); }
    .hex-title { color: #fff; font-weight: bold; font-size: 0.9rem; }
    .hex-cost { color: var(--accent-yellow); font-size: 0.8rem; font-family: monospace; }
    .hex-desc { color: #888; font-size: 0.75rem; line-height: 1.2; }

    /* --- GAME OVER --- */
    #game-over {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 1000; display: none;
        flex-direction: column; justify-content: center; align-items: center;
    }
    .go-text { font-size: 4rem; font-weight: 900; margin-bottom: 20px; }
    .win { color: var(--accent-red); text-shadow: 0 0 30px var(--accent-red); }
    .lose { color: var(--accent-blue); text-shadow: 0 0 30px var(--accent-blue); }
    
</style>
</head>
<body>

<div class="scanlines"></div>

<div id="game-shell">
    <header>
        <div class="date-display" id="date-display">DAY 1</div>
        <div class="news-bar">
            <div class="news-icon">NEWS</div>
            <div id="news-ticker">Outbreak detected in Ben Franklin College... Students report "cringe" content...</div>
        </div>
    </header>

    <div id="map-stage">
        <svg id="svg-map" viewBox="0 0 800 500" style="width:100%; height:100%;">
            <defs>
                <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
                    <feGaussianBlur stdDeviation="2" result="blur" />
                    <feComposite in="SourceGraphic" in2="blur" operator="over" />
                </filter>
            </defs>
            <g id="regions-layer"></g>
        </svg>
        <canvas id="fx-canvas"></canvas>
        <div id="bubble-layer"></div>

        <div id="evo-modal">
            <div class="evo-header">
                <div class="evo-tabs">
                    <button class="active" onclick="GameUI.setTab('transmission')">Transmission</button>
                    <button onclick="GameUI.setTab('symptoms')">Content</button>
                    <button onclick="GameUI.setTab('abilities')">Abilities</button>
                </div>
                <div style="color: var(--accent-yellow); font-weight: bold; font-size: 1.2rem;">
                    <span id="modal-dna">0</span> DNA
                </div>
                <button style="background:var(--accent-red); border:none; color:white; padding:5px 15px; cursor:pointer;" onclick="GameUI.toggleEvo(false)">CLOSE</button>
            </div>
            <div class="evo-body" id="evo-list"></div>
        </div>
        
        <div id="game-over">
            <div class="go-text" id="go-title">VICTORY</div>
            <div style="color:#aaa; margin-bottom:30px;" id="go-desc">Description</div>
            <button class="btn-disease" onclick="location.reload()">PLAY AGAIN</button>
        </div>
    </div>

    <div id="hud">
        <div class="panel-box">
            <div class="hud-title">REGION DATA: <span id="reg-name" style="color:#fff">WORLD</span></div>
            <div class="data-row"><span>POPULATION</span><span id="reg-pop">6000</span></div>
            <div class="data-row"><span>INFECTED</span><span id="reg-inf" class="val-red">0</span></div>
            <div class="data-row"><span>EXPELLED</span><span id="reg-dead" class="val-blue">0</span></div>
            
            <div style="flex:1"></div>
            
            <div class="hud-title">GLOBAL STATS</div>
            <div class="data-row"><span>DNA POINTS</span><span id="val-dna" class="val-gold">0</span></div>
            <div class="data-row"><span>TOTAL INFECTED</span><span id="val-total-inf" class="val-red">0</span></div>
        </div>

        <div class="center-controls">
            <div class="bar-container">
                <div class="bar-text">CAMPUS SATURATION</div>
                <div class="bar-fill bar-red" id="bar-inf"></div>
            </div>
            <div class="bar-container">
                <div class="bar-text">ADMIN BAN PROGRESS</div>
                <div class="bar-fill bar-blue" id="bar-ban"></div>
            </div>
            
            <div style="flex:1"></div>
            <button class="btn-disease" onclick="GameUI.toggleEvo(true)">DISEASE MENU</button>
        </div>

        <div class="panel-box" style="align-items:center; justify-content: space-between;">
            <div class="time-panel">
                <button class="btn-time" onclick="Game.setSpeed(0)">||</button>
                <button class="btn-time active" id="btn-s1" onclick="Game.setSpeed(1)">1</button>
                <button class="btn-time" id="btn-s2" onclick="Game.setSpeed(3)">2</button>
                <button class="btn-time" id="btn-s3" onclick="Game.setSpeed(6)">3</button>
            </div>
            
            <div class="big-circle-btn" onclick="AudioSys.playAlert()">
                <span>YALE</span>
                <span style="font-size:0.6rem; color:#666">CONNECT</span>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * MEME OUTBREAK: ULTIMATE
 * Includes Audio Synth, Particle System, Logic, and UI.
 */

/* --- AUDIO ENGINE (Web Audio API) --- */
const AudioSys = {
    ctx: null,
    init() {
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        this.ctx = new AudioContext();
    },
    playTone(freq, type, duration) {
        if (!this.ctx) this.init();
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start();
        osc.stop(this.ctx.currentTime + duration);
    },
    playPop() { this.playTone(400 + Math.random()*200, 'sine', 0.15); },
    playClick() { this.playTone(800, 'square', 0.05); },
    playAlert() { 
        if(!this.ctx) this.init();
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(150, this.ctx.currentTime);
        osc.frequency.linearRampToValueAtTime(100, this.ctx.currentTime + 0.5);
        gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
        gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 0.5);
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start();
        osc.stop(this.ctx.currentTime + 0.5);
    }
};

/* --- GAME DATA --- */
const CONFIG = {
    colleges: [
        { id: "BF", name: "Ben Franklin", x: 100, y: 380, w: 50, h: 50, pop: 450, type: "Physical" },
        { id: "BK", name: "Berkeley", x: 250, y: 380, w: 50, h: 50, pop: 400, type: "Social" },
        { id: "BR", name: "Branford", x: 400, y: 380, w: 50, h: 50, pop: 410, type: "Physical" },
        { id: "DC", name: "Davenport", x: 550, y: 380, w: 50, h: 50, pop: 430, type: "Academic" },
        { id: "ES", name: "Ezra Stiles", x: 100, y: 280, w: 50, h: 45, pop: 400, type: "Social" },
        { id: "GH", name: "Hopper", x: 250, y: 280, w: 40, h: 60, pop: 380, type: "Digital" },
        { id: "JE", name: "J. Edwards", x: 400, y: 280, w: 60, h: 40, pop: 380, type: "Academic" },
        { id: "MC", name: "Morse", x: 560, y: 280, w: 35, h: 60, pop: 400, type: "Physical" },
        { id: "PM", name: "Pauli Murray", x: 100, y: 180, w: 60, h: 40, pop: 450, type: "Digital" },
        { id: "PC", name: "Pierson", x: 300, y: 180, w: 50, h: 40, pop: 420, type: "Digital" },
        { id: "SY", name: "Saybrook", x: 450, y: 180, w: 50, h: 40, pop: 400, type: "Academic" },
        { id: "SM", name: "Silliman", x: 600, y: 180, w: 30, h: 45, pop: 440, type: "Social" },
        { id: "TD", name: "Tim Dwight", x: 180, y: 80, w: 70, h: 45, pop: 390, type: "Social" },
        { id: "TC", name: "Trumbull", x: 420, y: 80, w: 70, h: 45, pop: 390, type: "Academic" }
    ],
    upgrades: {
        transmission: [
            { id: "t1", name: "Insta Page", cost: 3, type: "Digital", desc: "Allows Digital Infection." },
            { id: "t2", name: "Woads", cost: 4, type: "Social", desc: "Allows Social Infection." },
            { id: "t3", name: "Chalking", cost: 3, type: "Physical", desc: "Allows Physical Infection." },
            { id: "t4", name: "Piazza", cost: 3, type: "Academic", desc: "Allows Academic Infection." },
            { id: "t5", name: "TikTok", cost: 10, req: "t1", desc: "Massive spread boost." }
        ],
        symptoms: [
            { id: "s1", name: "Caption", cost: 2, inf: 3, vis: 1, desc: "Mildly funny." },
            { id: "s2", name: "Cursed", cost: 5, inf: 6, vis: 4, desc: "High engagement." },
            { id: "s3", name: "Political", cost: 12, inf: 15, vis: 25, desc: "Huge spread, HUGE ban risk." },
            { id: "s4", name: "Deep Fried", cost: 8, inf: 8, vis: 2, desc: "Confuses admins." }
        ],
        abilities: [
            { id: "a1", name: "Obscurity", cost: 8, desc: "Slows Ban by 20%." },
            { id: "a2", name: "Alumni", cost: 15, desc: "Significant Ban reduction." },
            { id: "a3", name: "Mutation", cost: 12, desc: "Random free upgrade." }
        ]
    }
};

/* --- GAME LOGIC --- */
const Game = {
    state: {
        dna: 10, day: 1, tick: 0, speed: 1,
        ban: 0, visibility: 0, infectivity: 1,
        owned: [], paused: false, ended: false,
        selectedRegion: null
    },
    colleges: [],
    totalPop: 0,

    init() {
        // Init Colleges
        CONFIG.colleges.forEach(c => {
            Game.state.selectedRegion = null;
            Game.totalPop += c.pop;
            Game.colleges.push({
                ...c,
                inf: 0, dead: 0,
                color: 0
            });
        });
        
        // Infect Patient Zero
        Game.colleges[0].inf = 5; 
        
        // Initial Render
        GameUI.initMap();
        GameUI.updateHUD();
        
        // Loop
        requestAnimationFrame(Game.loop);
        
        // Ambience
        setTimeout(() => AudioSys.playAlert(), 1000);
    },

    setSpeed(s) {
        Game.state.speed = s;
        document.querySelectorAll('.btn-time').forEach((b,i) => {
            b.classList.remove('active');
            if ([0,1,3,6].indexOf(s) === i) b.classList.add('active');
        });
    },

    loop() {
        if (Game.state.ended) return;
        
        if (Game.state.speed > 0) {
            for(let i=0; i<Game.state.speed; i++) {
                Game.tick();
            }
            GameParticles.update();
        }
        requestAnimationFrame(Game.loop);
    },

    tick() {
        Game.state.tick++;
        
        // Hourly Logic (Every 60 ticks)
        if (Game.state.tick % 60 === 0) {
            Game.updateInfection();
            Game.updateBan();
        }
        
        // Daily Logic
        if (Game.state.tick % 1440 === 0) {
            Game.state.day++;
            GameUI.ticker("Another day on campus...");
        }

        GameUI.updateHUD();
    },

    updateInfection() {
        let totalInf = 0;
        
        Game.colleges.forEach(c => {
            if (c.inf > 0 && c.inf < c.pop) {
                // Logistic-ish growth
                let rate = (Game.state.infectivity * 0.05) + (c.inf * 0.002);
                let growth = Math.ceil(rate);
                let actual = Math.min(c.pop - c.inf - c.dead, growth);
                c.inf += actual;
                
                // Particles
                if (Math.random() < 0.3) GameParticles.spawn(c);
            }
            
            // Spread to neighbors
            if (c.inf > 0 && Math.random() < 0.01 * Game.state.infectivity) {
                let target = Game.colleges[Math.floor(Math.random() * Game.colleges.length)];
                if (target.inf === 0) {
                    // Access Check
                    let hasAccess = Game.state.owned.some(u => u.type === target.type);
                    if (hasAccess || Game.state.owned.length === 0 && target === Game.colleges[0]) {
                        target.inf = 1;
                        GameUI.spawnBubble(target.x, target.y, 'dna');
                        GameUI.ticker(`Outbreak in ${target.name}!`);
                        AudioSys.playAlert();
                    }
                } else {
                    // Show travel particle
                    GameParticles.travel(c, target);
                }
            }
            
            totalInf += c.inf;
            GameUI.colorCollege(c);
        });
        
        // Win Condition
        if (totalInf >= Game.totalPop * 0.99) Game.end(true);
    },

    updateBan() {
        let totalInf = Game.colleges.reduce((a,b) => a + b.inf, 0);
        if (totalInf > 50) {
            // Ban Logic
            let rate = (Game.state.visibility * 0.002) + 0.01;
            
            // Reducers
            if (Game.has('a1')) rate *= 0.8;
            if (Game.has('a2')) rate *= 0.5;

            Game.state.ban += rate;
            
            // Expulsion logic (People getting banned/expelled)
            if (Game.state.ban > 20) {
                Game.colleges.forEach(c => {
                    if (c.inf > 0) {
                        let killed = Math.ceil(c.inf * (Game.state.ban / 2000));
                        if (killed > 0) {
                            c.inf -= killed;
                            c.dead += killed;
                        }
                    }
                });
            }
            
            // Cure Bubble
            if (Math.random() < 0.005) {
                let r = Game.colleges[Math.floor(Math.random()*Game.colleges.length)];
                GameUI.spawnBubble(r.x, r.y, 'cure');
            }
        }
        
        if (Game.state.ban >= 100) Game.end(false);
    },

    has(id) { return Game.state.owned.some(u => u.id === id); },

    buy(u) {
        if (Game.state.dna >= u.cost) {
            Game.state.dna -= u.cost;
            Game.state.owned.push(u);
            if (u.inf) Game.state.infectivity += u.inf;
            if (u.vis) Game.state.visibility += u.vis;
            GameUI.renderEvo();
            AudioSys.playClick();
        }
    },

    end(win) {
        Game.state.ended = true;
        document.getElementById('game-over').style.display = 'flex';
        document.getElementById('go-title').className = win ? 'go-text win' : 'go-text lose';
        document.getElementById('go-title').innerText = win ? "VICTORY" : "BANNED";
        document.getElementById('go-desc').innerText = win ? "Your meme is legendary." : "The Administration erased it.";
        if(win) AudioSys.playAlert();
    }
};

/* --- UI SYSTEM --- */
const GameUI = {
    currentTab: 'transmission',
    
    initMap() {
        const svg = document.getElementById('regions-layer');
        Game.colleges.forEach((c, i) => {
            let g = document.createElementNS("http://www.w3.org/2000/svg", "g");
            g.setAttribute("class", "college-group");
            g.onclick = () => GameUI.selectRegion(i);
            
            let rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            rect.setAttribute("x", c.x * 1);
            rect.setAttribute("y", c.y * 1);
            rect.setAttribute("width", c.w);
            rect.setAttribute("height", c.h);
            rect.setAttribute("class", "college-shape");
            rect.setAttribute("id", `shp-${c.id}`);
            
            let txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
            txt.setAttribute("x", c.x);
            txt.setAttribute("y", c.y - 5);
            txt.setAttribute("class", "college-label");
            txt.textContent = c.id;
            
            g.appendChild(rect);
            g.appendChild(txt);
            svg.appendChild(g);
        });
        
        // Canvas setup
        const cvs = document.getElementById('fx-canvas');
        cvs.width = 800; cvs.height = 500;
        GameParticles.ctx = cvs.getContext('2d');
    },

    selectRegion(idx) {
        Game.state.selectedRegion = idx;
        let c = Game.colleges[idx];
        document.getElementById('reg-name').innerText = c.name;
        AudioSys.playClick();
        GameUI.updateHUD();
    },

    colorCollege(c) {
        let intensity = c.inf / c.pop;
        let el = document.getElementById(`shp-${c.id}`);
        // Red intensity
        el.style.fill = `rgb(${42 + (intensity * 200)}, 42, 42)`;
        if (c.inf > 0 && c.inf < c.pop) el.style.stroke = "#fff";
        else el.style.stroke = "#444";
    },

    spawnBubble(x, y, type) {
        let b = document.createElement('div');
        b.className = `bubble ${type}`;
        b.style.left = (x + Math.random()*20) + 'px';
        b.style.top = (y + Math.random()*20) + 'px';
        
        if (type === 'dna') {
            b.innerHTML = "+";
            b.onclick = () => { 
                Game.state.dna += (1 + Math.floor(Math.random()*2)); 
                AudioSys.playPop(); 
                b.remove(); 
                GameUI.updateHUD(); 
            };
        } else {
            b.innerHTML = "!";
            b.onclick = () => {
                Game.state.ban = Math.max(0, Game.state.ban - 5);
                AudioSys.playPop();
                b.remove();
                GameUI.updateHUD();
            };
        }
        
        document.getElementById('bubble-layer').appendChild(b);
        setTimeout(() => b.remove(), 4000);
    },

    updateHUD() {
        // Global
        let totalInf = Game.colleges.reduce((a,b)=>a+b.inf,0);
        document.getElementById('val-dna').innerText = Game.state.dna;
        document.getElementById('modal-dna').innerText = Game.state.dna;
        document.getElementById('val-total-inf').innerText = totalInf;
        document.getElementById('date-display').innerText = `DAY ${Game.state.day}`;
        
        // Bars
        document.getElementById('bar-inf').style.width = (totalInf / Game.totalPop * 100) + '%';
        document.getElementById('bar-ban').style.width = Game.state.ban + '%';
        
        // Region
        if (Game.state.selectedRegion !== null) {
            let c = Game.colleges[Game.state.selectedRegion];
            document.getElementById('reg-pop').innerText = c.pop;
            document.getElementById('reg-inf').innerText = c.inf;
            document.getElementById('reg-dead').innerText = c.dead;
        }
    },

    ticker(msg) {
        let el = document.getElementById('news-ticker');
        el.innerText = msg;
        el.style.animation = 'none';
        el.offsetHeight; 
        el.style.animation = 'ticker 15s linear infinite';
    },

    toggleEvo(show) {
        document.getElementById('evo-modal').style.display = show ? 'flex' : 'none';
        if(show) GameUI.renderEvo();
        AudioSys.playClick();
    },

    setTab(t) {
        GameUI.currentTab = t;
        document.querySelectorAll('.evo-tabs button').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        GameUI.renderEvo();
        AudioSys.playClick();
    },

    renderEvo() {
        const list = document.getElementById('evo-list');
        list.innerHTML = '';
        CONFIG.upgrades[GameUI.currentTab].forEach(u => {
            let owned = Game.has(u.id);
            let locked = false;
            if (u.req && !Game.has(u.req)) locked = true;
            
            let el = document.createElement('div');
            el.className = `hex-upgrade ${owned?'owned':''} ${locked?'locked':''}`;
            el.innerHTML = `<div class="hex-title">${u.name}</div><div class="hex-cost">${owned?'OWNED':u.cost}</div><div class="hex-desc">${u.desc}</div>`;
            if (!owned && !locked) el.onclick = () => Game.buy(u);
            list.appendChild(el);
        });
    }
};

/* --- PARTICLE SYSTEM --- */
const GameParticles = {
    particles: [],
    ctx: null,
    
    spawn(c) {
        this.particles.push({
            x: c.x + 25, y: c.y + 25,
            vx: (Math.random()-0.5)*1, vy: (Math.random()-0.5)*1,
            life: 50, color: '#cc0000'
        });
    },
    travel(s, t) {
        this.particles.push({
            x: s.x + 25, y: s.y + 25,
            tx: t.x + 25, ty: t.y + 25,
            travel: true, life: 100, color: '#ffcc00'
        });
    },
    update() {
        if(!this.ctx) return;
        this.ctx.clearRect(0,0,800,500);
        for(let i=this.particles.length-1; i>=0; i--) {
            let p = this.particles[i];
            if(p.travel) {
                p.x += (p.tx - p.x)*0.05;
                p.y += (p.ty - p.y)*0.05;
                if(Math.abs(p.x-p.tx)<1) p.life=0;
            } else {
                p.x+=p.vx; p.y+=p.vy; p.life--;
            }
            this.ctx.fillStyle = p.color;
            this.ctx.fillRect(p.x, p.y, 2, 2);
            if(p.life<=0) this.particles.splice(i,1);
        }
    }
};

// START
window.onload = Game.init;
</script>
</body>
</html>
